<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Web Audio Tests</title>
    <style>
        #ndp-input {
            display: none;
        }
    </style>

    <script>
        'use strict'

        function log(...args) {
            console.info(...args)
        }

        let strips = []

        const audioContext = new AudioContext()

        function glitchHandler(name) {
            return (event) => {
                log(`Glitch "${name}" in ${event.target.id}`)
            }
        }

        async function handleFilesStreamTest(event) {
            const { dir, files } = event.detail

            // cleanup
            strips.forEach((strip) => {
                strip.audioElement.pause()
                strip.source.disconnect()
                delete strip.source // probably not useful
                delete strip.audioElement
            })
            strips = []
            //    await tick()

            // get files
            const fileInfos = [...files]
                .map((handle) => {
                    const result =
                        /^\d*\s*(.*?)(?:\.[^.]*)?$/g.exec(handle.name) ?? handle.name
                    const label = result !== null ? result[1] : handle.name
                    return {
                        handle,
                        label,
                        type: handle.type,
                        url: URL.createObjectURL(handle), // TODO see if need to free on delete
                    }
                })
                .filter(
                    ({ type }) =>
                        type == 'audio/mpeg' || type == 'audio/wav' || type == 'audio/x-wav',
                )

            if (audioContext.state === 'suspended') {
                audioContext.resume()
            }

            let readyChannels = []

            // set up
            fileInfos.forEach((el, i) => {
                const strip = {}
                strip.info = el
                strip.audioElement = new Audio(el.url)
                strip.audioElement.id = i
                strip.audioElement.preload = 'auto' // might not matter
                readyChannels.push(
                    new Promise((resolve) => {
                        strip.audioElement.oncanplaythrough = () => {
                            resolve(i)
                        }
                    }),
                )
                strip.audioElement.onplay = (el) => {
                    log(
                        'Play ' + el.target.id,
                        audioContext.currentTime,
                        strip.info.label,
                    )
                }
                strip.audioElement.onerror = glitchHandler('error')
                strip.audioElement.onstalled = glitchHandler('stalled')
                strip.audioElement.onwaiting = glitchHandler('waiting')

                strip.source = audioContext.createMediaElementSource(strip.audioElement)
                //const gainNode = audioContext.createGain()
                strip.source.connect(audioContext.destination)

                strips.push(strip)
            })

            // wait for ready
            await Promise.all(readyChannels)

            // play
            strips.forEach((strip, i) => {
                strip.audioElement.play()
            })
        }

        let files = []

        async function handleSelectFolder() {
            const files = await filePicker()
            if (files.files.length) {
                //dispatch('filesSelected', files)
            }
        }

        function handleChange(event) {
            file = [...event.target.files]
        }

    </script>
</head>

<body>
    <h1>Web Audio Tests</h1>
    <button id="hdp" onclick="handleSelectFolder(event)">Select Folder</button>
    <div id="ndp">
        <button onclick="document.querySelector('#ndp-input').click()">Select Folder</button>
        <input id="ndp-input" type="file" webkitdirectory accept="audio/*" onchange="handleChange(event)" />
    </div>

    <button onclick="handleFilesStreamTest(event)">Stream Test</button>
</body>

<script>
    'use strict'
    if (window.showDirectoryPicker) {
        document.body.removeChild(document.querySelector('#ndp'))
    } else {
        document.body.removeChild(document.querySelector('#hdp'))

    }
</script>

</html>